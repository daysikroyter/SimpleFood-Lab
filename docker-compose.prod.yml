version: '3.8'

services:
  # API Gateway
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: simplefood-api-gateway-prod
    restart: always
    ports:
      - "9000:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
    volumes:
      - ./services/api-gateway:/var/www
    networks:
      - simplefood-network
    depends_on:
      - auth-service
      - catalog-service
      - cart-service
      - order-service
      - payment-service
      - admin-service

  # Auth Service
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: simplefood-auth-service-prod
    restart: always
    ports:
      - "8001:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-auth
      - DB_DATABASE=auth_db
      - DB_USERNAME=${AUTH_DB_USERNAME}
      - DB_PASSWORD=${AUTH_DB_PASSWORD}
    volumes:
      - ./services/auth-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-auth

  # Catalog Service
  catalog-service:
    build:
      context: ./services/catalog-service
      dockerfile: Dockerfile
    container_name: simplefood-catalog-service-prod
    restart: always
    ports:
      - "8002:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-catalog
      - DB_DATABASE=catalog_db
      - DB_USERNAME=${CATALOG_DB_USERNAME}
      - DB_PASSWORD=${CATALOG_DB_PASSWORD}
    volumes:
      - ./services/catalog-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-catalog

  # Cart Service
  cart-service:
    build:
      context: ./services/cart-service
      dockerfile: Dockerfile
    container_name: simplefood-cart-service-prod
    restart: always
    ports:
      - "8003:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-cart
      - DB_DATABASE=cart_db
      - DB_USERNAME=${CART_DB_USERNAME}
      - DB_PASSWORD=${CART_DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./services/cart-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-cart
      - redis

  # Order Service
  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: simplefood-order-service-prod
    restart: always
    ports:
      - "8000:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-orders
      - DB_DATABASE=orders_db
      - DB_USERNAME=${ORDER_DB_USERNAME}
      - DB_PASSWORD=${ORDER_DB_PASSWORD}
    volumes:
      - ./services/order-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-orders

  # Payment Service
  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: simplefood-payment-service-prod
    restart: always
    ports:
      - "8004:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-payments
      - DB_DATABASE=payments_db
      - DB_USERNAME=${PAYMENT_DB_USERNAME}
      - DB_PASSWORD=${PAYMENT_DB_PASSWORD}
    volumes:
      - ./services/payment-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-payments

  # Admin Service
  admin-service:
    build:
      context: ./services/admin-service
      dockerfile: Dockerfile
    container_name: simplefood-admin-service-prod
    restart: always
    ports:
      - "8005:80"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql-admin
      - DB_DATABASE=admin_db
      - DB_USERNAME=${ADMIN_DB_USERNAME}
      - DB_PASSWORD=${ADMIN_DB_PASSWORD}
    volumes:
      - ./services/admin-service:/var/www
    networks:
      - simplefood-network
    depends_on:
      - mysql-admin

  # Databases
  mysql-auth:
    image: mysql:8.0
    container_name: simplefood-mysql-auth-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${AUTH_DB_PASSWORD}
      MYSQL_DATABASE: auth_db
      MYSQL_USER: ${AUTH_DB_USERNAME}
      MYSQL_PASSWORD: ${AUTH_DB_PASSWORD}
    volumes:
      - mysql-auth-data:/var/lib/mysql
    networks:
      - simplefood-network

  mysql-catalog:
    image: mysql:8.0
    container_name: simplefood-mysql-catalog-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${CATALOG_DB_PASSWORD}
      MYSQL_DATABASE: catalog_db
      MYSQL_USER: ${CATALOG_DB_USERNAME}
      MYSQL_PASSWORD: ${CATALOG_DB_PASSWORD}
    volumes:
      - mysql-catalog-data:/var/lib/mysql
    networks:
      - simplefood-network

  mysql-cart:
    image: mysql:8.0
    container_name: simplefood-mysql-cart-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${CART_DB_PASSWORD}
      MYSQL_DATABASE: cart_db
      MYSQL_USER: ${CART_DB_USERNAME}
      MYSQL_PASSWORD: ${CART_DB_PASSWORD}
    volumes:
      - mysql-cart-data:/var/lib/mysql
    networks:
      - simplefood-network

  mysql-orders:
    image: mysql:8.0
    container_name: simplefood-mysql-orders-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${ORDER_DB_PASSWORD}
      MYSQL_DATABASE: orders_db
      MYSQL_USER: ${ORDER_DB_USERNAME}
      MYSQL_PASSWORD: ${ORDER_DB_PASSWORD}
    volumes:
      - mysql-orders-data:/var/lib/mysql
    networks:
      - simplefood-network

  mysql-payments:
    image: mysql:8.0
    container_name: simplefood-mysql-payments-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${PAYMENT_DB_PASSWORD}
      MYSQL_DATABASE: payments_db
      MYSQL_USER: ${PAYMENT_DB_USERNAME}
      MYSQL_PASSWORD: ${PAYMENT_DB_PASSWORD}
    volumes:
      - mysql-payments-data:/var/lib/mysql
    networks:
      - simplefood-network

  mysql-admin:
    image: mysql:8.0
    container_name: simplefood-mysql-admin-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${ADMIN_DB_PASSWORD}
      MYSQL_DATABASE: admin_db
      MYSQL_USER: ${ADMIN_DB_USERNAME}
      MYSQL_PASSWORD: ${ADMIN_DB_PASSWORD}
    volumes:
      - mysql-admin-data:/var/lib/mysql
    networks:
      - simplefood-network

  # Redis для кеширования
  redis:
    image: redis:7-alpine
    container_name: simplefood-redis-prod
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - simplefood-network

  # RabbitMQ для очередей сообщений между сервисами
  rabbitmq:
    image: rabbitmq:3-management
    container_name: simplefood-rabbitmq-prod
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    networks:
      - simplefood-network

  # Nginx Load Balancer (опционально)
  nginx-lb:
    image: nginx:alpine
    container_name: simplefood-nginx-lb
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx-lb.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
    networks:
      - simplefood-network
    depends_on:
      - api-gateway

networks:
  simplefood-network:
    driver: bridge

volumes:
  mysql-auth-data:
  mysql-catalog-data:
  mysql-cart-data:
  mysql-orders-data:
  mysql-payments-data:
  mysql-admin-data:
